# 邮件通知配置说明

本项目已配置了GitHub Actions的邮件通知功能，当JMeter测试执行成功或失败时会自动发送邮件通知。

## 配置步骤

### 1. 设置GitHub Secrets

在GitHub仓库的Settings > Secrets and variables > Actions中添加以下secrets：

#### 必需配置
- `MAIL_USERNAME`: 发件人邮箱地址（Gmail推荐）
- `MAIL_PASSWORD`: 邮箱密码或应用专用密码
- `NOTIFICATION_EMAIL`: 收件人邮箱地址（可以设置多个，用逗号分隔）

#### 可选配置
- `COMPANY_PAT`: 公司仓库访问令牌（用于company_pat.yml workflow）

### 2. Gmail配置说明

如果使用Gmail作为发件邮箱：

1. 开启两步验证
2. 生成应用专用密码：
   - 访问 https://myaccount.google.com/apppasswords
   - 选择"邮件"应用 
   - 生成16位应用专用密码 gvnw wjta kgrx ndxa
   - 将生成的密码设置为`MAIL_PASSWORD`

### 3. 其他邮箱服务商

如果使用其他邮箱服务商，请相应调整以下配置：

```yaml
server_address: smtp.qq.com    # QQ邮箱
server_port: 587              # 端口号
```

常见邮箱服务商配置：

| 服务商 | SMTP服务器 | 端口 | 说明 |
|--------|------------|------|------|
| Gmail | smtp.gmail.com | 587 | 需要应用专用密码 |
| QQ邮箱 | smtp.qq.com | 587 | 需要授权码 |
| 163邮箱 | smtp.163.com | 25/465/994 | 需要授权码 |
| Outlook | smtp-mail.outlook.com | 587 | 需要应用专用密码 |

## 通知内容

### JMeter CI (jmeter.yml)
- **成功通知**: ✅ JMeter CI 测试成功
- **失败通知**: ❌ JMeter CI 测试失败

### 公司仓库监控 (company_pat.yml) - 优化版本

为了避免邮件轰炸，公司仓库监控采用了分阶段通知策略：

#### 1. 检测阶段通知
- **检测失败**: ⚠️ 公司仓库监控检测失败
  - 只在检测阶段失败时发送
  - 包含详细的故障排除建议
  - 避免因网络问题等导致的误报

- **无更新通知**: ℹ️ 公司仓库无更新
  - **方案A**: 每天最多发送一次（当前默认）
  - **方案B**: 完全禁用（使用company_pat_no_notification.yml）

#### 2. 测试阶段通知
- **测试成功**: ✅ 公司仓库监控测试成功
  - 只在有更新且测试成功时发送
  - 包含测试报告下载链接

- **测试失败**: ❌ 公司仓库监控测试失败
  - 只在有更新但测试失败时发送
  - 包含问题排查链接

### 无更新邮件处理方案

#### 方案A: 每天最多一封（推荐）
- 使用 `company_pat.yml`
- 每天只发送第一封无更新邮件
- 后续检测到无更新时静默跳过
- 第二天重新开始计数

### 通知频率优化

| 情况 | 通知类型 | 频率 | 说明 |
|------|----------|------|------|
| 检测失败 | 警告通知 | 每次失败 | 需要立即关注 |
| 无更新 | 信息通知 | 每天最多一次 | 确认系统正常 |
| 有更新+测试成功 | 成功通知 | 每次成功 | 正常流程 |
| 有更新+测试失败 | 失败通知 | 每次失败 | 需要修复 |

## 测试邮件通知

配置完成后，可以通过以下方式测试邮件通知：

1. 手动触发workflow（在GitHub Actions页面点击"Run workflow"）
2. 推送代码到触发分支
3. 创建Pull Request

## 故障排除

### 邮件发送失败
1. 检查secrets配置是否正确
2. 确认邮箱服务商设置
3. 查看GitHub Actions日志中的错误信息

### 收不到邮件
1. 检查垃圾邮件文件夹
2. 确认收件邮箱地址正确
3. 检查邮箱服务商的过滤设置

### 公司仓库监控问题
1. 检查 `COMPANY_PAT` token 是否有效
2. 确认仓库地址和分支名称正确
3. 验证网络连接和GitHub API状态

## 安全注意事项

- 不要在代码中硬编码邮箱密码
- 定期更换应用专用密码
- 使用专门的测试邮箱进行通知
- 限制收件人范围，避免信息泄露
- 定期检查GitHub Secrets的有效性 