name: App BFF API Tests

on:
  push:
    branches: [ "web", "main", "hxh-apitest-development" ]
  pull_request:
    branches: [ "web", "main", "hxh-apitest-development" ]

jobs:
  jmeter:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install JMeter
        run: |
          wget https://mirrors.tuna.tsinghua.edu.cn/apache/jmeter/binaries/apache-jmeter-5.6.3.tgz
          tar -xzf apache-jmeter-5.6.3.tgz

      - name: Install JMeter Plugins Manager and JSON Path Assertion
        run: |
          wget https://repo1.maven.org/maven2/kg/apc/cmdrunner/2.3/cmdrunner-2.3.jar -O ./apache-jmeter-5.6.3/lib/cmdrunner-2.3.jar
          # jmeter-plugins.org/get/ æœ‰æ—¶ä¼šè¿”å› 404ï¼Œæ”¹ä¸ºä» Maven Central ä¸‹è½½æŒ‡å®šç‰ˆæœ¬
          PLUGIN_VERSION=1.8
          wget https://repo1.maven.org/maven2/kg/apc/jmeter-plugins-manager/${PLUGIN_VERSION}/jmeter-plugins-manager-${PLUGIN_VERSION}.jar -O ./apache-jmeter-5.6.3/lib/ext/jmeter-plugins-manager.jar
          # ç›´æ¥æ‰‹åŠ¨ä¸‹è½½ JSON Path Assertion æ’ä»¶ï¼Œé¿å…ä¾èµ–åœ¨çº¿ä»“åº“
          JSON_PLUGIN_VERSION=2.7
          wget https://repo1.maven.org/maven2/kg/apc/jmeter-plugins-json/${JSON_PLUGIN_VERSION}/jmeter-plugins-json-${JSON_PLUGIN_VERSION}.jar -O ./apache-jmeter-5.6.3/lib/ext/jmeter-plugins-json.jar

      - name: Prepare reports directory
        run: |
          # æ¸…ç†æ•´ä¸ªreportsç›®å½•ï¼ŒåŒ…æ‹¬æ—§çš„jmeter-reportç›®å½•
          rm -rf reports
          mkdir -p reports

      - name: Run App BFF JMeter Tests
        run: |
          # ä½¿ç”¨ App BFF ä¸“ç”¨è„šæœ¬æ¥æ‰§è¡Œæ‰€æœ‰æµ‹è¯•
          # è„šæœ¬ä¼šè‡ªåŠ¨å¤„ç†é»‘åå•ã€é”™è¯¯å¤„ç†å’ŒæŠ¥å‘Šç”Ÿæˆ
          bash scripts/run_app_tests.sh

      - name: Analyze Test Results
        id: test_results
        run: |
          # åˆ†ææµ‹è¯•ç»“æœï¼Œæå–å¤±è´¥ç”¨ä¾‹ä¿¡æ¯
          echo "=== æµ‹è¯•ç»“æœåˆ†æ ===" > reports/test_summary.txt
          echo "æ€»æµ‹è¯•ç”¨ä¾‹æ•°: $(grep -c '^[0-9]' reports/jmeter-report/all_cases.jtl)" >> reports/test_summary.txt
          echo "æˆåŠŸç”¨ä¾‹æ•°: $(awk -F',' '$8 == "true" {count++} END {print count+0}' reports/jmeter-report/all_cases.jtl)" >> reports/test_summary.txt
          echo "å¤±è´¥ç”¨ä¾‹æ•°: $(awk -F',' '$8 == "false" {count++} END {print count+0}' reports/jmeter-report/all_cases.jtl)" >> reports/test_summary.txt
          echo "" >> reports/test_summary.txt
          
          # ç»Ÿè®¡å¤±è´¥ç”¨ä¾‹æ•°é‡ - ä½¿ç”¨ç²¾ç¡®çš„å­—æ®µè§£æ
          failed_count=$(awk -F',' '$8 == "false" {count++} END {print count+0}' reports/jmeter-report/all_cases.jtl)
          echo "failed_count=$failed_count" >> $GITHUB_OUTPUT
          
          # æå–å¤±è´¥çš„ç”¨ä¾‹è¯¦æƒ…
          if [ $failed_count -gt 0 ]; then
            echo "=== å¤±è´¥çš„æµ‹è¯•ç”¨ä¾‹ ===" >> reports/test_summary.txt
            # ä½¿ç”¨æ›´ç²¾ç¡®çš„å­—æ®µè§£æï¼ŒJTLæ–‡ä»¶æ ¼å¼ï¼štimestamp,elapsed,label,responseCode,responseMessage,threadName,dataType,success,failureMessage,bytes,sentBytes,grpThreads,allThreads,URL,filename,latencyId,connectTime
            awk -F',' '$8 == "false" {print "ç”¨ä¾‹: " $3 "\nå“åº”ç : " $4 "\nå¤±è´¥åŸå› : " $9 "\n"}' reports/jmeter-report/all_cases.jtl >> reports/test_summary.txt
          else
            echo "æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹éƒ½æ‰§è¡ŒæˆåŠŸï¼" >> reports/test_summary.txt
          fi
          
          # æ˜¾ç¤ºæµ‹è¯•æ‘˜è¦
          cat reports/test_summary.txt
          
          # è®¾ç½®è¾“å‡ºå˜é‡
          echo "summary<<EOF" >> $GITHUB_OUTPUT
          cat reports/test_summary.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Upload reports
        uses: actions/upload-artifact@v4
        with:
          name: jmeter-reports
          path: reports/

      - name: Send success notification
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: ${{ steps.test_results.outputs.failed_count > 0 && 'âŒ JMeter App API æµ‹è¯•å¤±è´¥' || 'âœ… JMeter App API æµ‹è¯•æˆåŠŸ' }} - ${{ github.repository }}
          to: ${{ secrets.NOTIFICATION_EMAIL }}
          from: ${{ secrets.MAIL_USERNAME }}
          body: |
            ${{ steps.test_results.outputs.failed_count > 0 && 'ğŸš¨ JMeter App API æµ‹è¯•æ‰§è¡Œå®Œæˆï¼Œä½†æœ‰å¤±è´¥ç”¨ä¾‹ï¼' || 'ğŸ‰ JMeter App API æµ‹è¯•æ‰§è¡ŒæˆåŠŸï¼' }}
            
            ğŸ“Š æµ‹è¯•è¯¦æƒ…:
            - ä»“åº“: ${{ github.repository }}
            - åˆ†æ”¯: ${{ github.ref_name }}
            - æäº¤: ${{ github.sha }}
            - è§¦å‘è€…: ${{ github.actor }}
            - æ‰§è¡Œæ—¶é—´: ${{ github.event.head_commit.timestamp }}
            
            ğŸ“ˆ æµ‹è¯•ç»“æœæ‘˜è¦:
            ${{ steps.test_results.outputs.summary }}
            
            ğŸ“ è¯¦ç»†æµ‹è¯•æŠ¥å‘Šå·²ç”Ÿæˆï¼Œå¯åœ¨ GitHub Actions ä¸­ä¸‹è½½ã€‚
            
            ğŸ”— æŸ¥çœ‹è¯¦æƒ…: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

      - name: Send failure notification
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "âŒ JMeter App API æµ‹è¯•å¤±è´¥ - ${{ github.repository }}"
          to: ${{ secrets.NOTIFICATION_EMAIL }}
          from: ${{ secrets.MAIL_USERNAME }}
          body: |
            ğŸš¨ JMeter App API æµ‹è¯•æ‰§è¡Œå¤±è´¥ï¼
            
            ğŸ“Š å¤±è´¥è¯¦æƒ…:
            - ä»“åº“: ${{ github.repository }}
            - åˆ†æ”¯: ${{ github.ref_name }}
            - æäº¤: ${{ github.sha }}
            - è§¦å‘è€…: ${{ github.actor }}
            - æ‰§è¡Œæ—¶é—´: ${{ github.event.head_commit.timestamp }}
            
            ğŸ“ˆ æµ‹è¯•ç»“æœæ‘˜è¦:
            ${{ steps.test_results.outputs.summary }}
            
            âš ï¸ è¯·ç«‹å³æ£€æŸ¥æµ‹è¯•å¤±è´¥åŸå› å¹¶ä¿®å¤é—®é¢˜ã€‚
            
            ğŸ”— æŸ¥çœ‹è¯¦æƒ…: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
