name: JMeter CI

on:
  push:
    branches: [ feature/jmeter-login-only ]
  pull_request:
    branches: [ feature/jmeter-login-only ]

jobs:
  jmeter:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install JMeter
        run: |
          wget https://mirrors.tuna.tsinghua.edu.cn/apache/jmeter/binaries/apache-jmeter-5.6.3.tgz
          tar -xzf apache-jmeter-5.6.3.tgz

      - name: Install JMeter Plugins Manager and JSON Path Assertion
        run: |
          wget https://repo1.maven.org/maven2/kg/apc/cmdrunner/2.3/cmdrunner-2.3.jar -O ./apache-jmeter-5.6.3/lib/cmdrunner-2.3.jar
          wget https://jmeter-plugins.org/get/ -O ./apache-jmeter-5.6.3/lib/ext/jmeter-plugins-manager.jar
          java -cp ./apache-jmeter-5.6.3/lib/ext/jmeter-plugins-manager.jar org.jmeterplugins.repository.PluginManagerCMDInstaller
          ./apache-jmeter-5.6.3/bin/PluginsManagerCMD.sh install jpgc-json

      - name: Prepare reports directory
        run: mkdir -p reports

      - name: Run Login Test
        run: |
          ./apache-jmeter-5.6.3/bin/jmeter -n -t testcases/tg1_auth_login.jmx -q config/dev.env.properties -l reports/tg1_auth_login.jtl -e -o reports/tg1_auth_login_report

      - name: Run Selected Testcases
        run: |
          for file in testcases/*.jmx; do
            fname=$(basename "$file")
            if [[ "$fname" != tg1_auth_login.jmx && "$fname" != tg6_forgot_password.jmx && "$fname" != tg21_vip_phone.jmx && "$fname" != tg22_vip_reply.jmx && "$fname" != tg23_auth_reset_pwd.jmx && "$fname" != tglast_auth_forgot_pwd.jmx ]]; then
              ./apache-jmeter-5.6.3/bin/jmeter -n -t "$file" -q config/dev.env.properties -l "reports/${fname%.jmx}.jtl" -e -o "reports/${fname%.jmx}_report"
            fi
          done

      - name: Upload reports
        uses: actions/upload-artifact@v4
        with:
          name: jmeter-reports
          path: reports/
