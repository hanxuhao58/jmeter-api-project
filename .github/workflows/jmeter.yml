name: JMeter CI

on:
  push:
    branches: [ feature/jmeter-login-only ]
  pull_request:
    branches: [ feature/jmeter-login-only ]

jobs:
  jmeter:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install JMeter
        run: |
          wget https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-5.6.3.tgz
          tar -xzf apache-jmeter-5.6.3.tgz

      - name: Install JMeter Plugins Manager and JSON Path Assertion
        run: |
          wget https://jmeter-plugins.org/get/ -O ./apache-jmeter-5.6.3/lib/ext/jmeter-plugins-manager.jar
          java -cp ./apache-jmeter-5.6.3/lib/ext/jmeter-plugins-manager.jar org.jmeterplugins.repository.PluginManagerCMDInstaller
          ./apache-jmeter-5.6.3/bin/PluginsManagerCMD.sh install jpgc-json

      - name: Run Login Test
        run: |
          ./apache-jmeter-5.6.3/bin/jmeter -n -t testcases/tg1_auth_login.jmx -q config/dev.env.properties

#      - name: Run All Other Tests
#        run: |
#          for file in testcases/*.jmx; do
#            if [[ "$file" != *tg1_auth_login.jmx ]]; then
#              ./apache-jmeter-5.6.3/bin/jmeter -n -t "$file" -q config/dev.env.properties -l "reports/$(basename $file .jmx).jtl" -e -o "reports/$(basename $file .jmx)_report"
#            fi
#          done

      - name: Upload reports
        uses: actions/upload-artifact@v4
        with:
          name: jmeter-reports
          path: reports/
