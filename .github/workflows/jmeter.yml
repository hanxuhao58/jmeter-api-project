name: JMeter App API Tests

on:
  push:
    branches: [ "main", "web" ]
  pull_request:
    branches: [ "main", "web" ]

jobs:
  jmeter:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install JMeter
        run: |
          wget https://mirrors.tuna.tsinghua.edu.cn/apache/jmeter/binaries/apache-jmeter-5.6.3.tgz
          tar -xzf apache-jmeter-5.6.3.tgz

      - name: Install JMeter Plugins Manager and JSON Path Assertion
        run: |
          wget https://repo1.maven.org/maven2/kg/apc/cmdrunner/2.3/cmdrunner-2.3.jar -O ./apache-jmeter-5.6.3/lib/cmdrunner-2.3.jar
          # jmeter-plugins.org/get/ æœ‰æ—¶ä¼šè¿”å› 404ï¼Œæ”¹ä¸ºä» Maven Central ä¸‹è½½æŒ‡å®šç‰ˆæœ¬
          PLUGIN_VERSION=1.8
          wget https://repo1.maven.org/maven2/kg/apc/jmeter-plugins-manager/${PLUGIN_VERSION}/jmeter-plugins-manager-${PLUGIN_VERSION}.jar -O ./apache-jmeter-5.6.3/lib/ext/jmeter-plugins-manager.jar
          # ç›´æ¥æ‰‹åŠ¨ä¸‹è½½ JSON Path Assertion æ’ä»¶ï¼Œé¿å…ä¾èµ–åœ¨çº¿ä»“åº“
          JSON_PLUGIN_VERSION=2.7
          wget https://repo1.maven.org/maven2/kg/apc/jmeter-plugins-json/${JSON_PLUGIN_VERSION}/jmeter-plugins-json-${JSON_PLUGIN_VERSION}.jar -O ./apache-jmeter-5.6.3/lib/ext/jmeter-plugins-json.jar

      - name: Prepare reports directory
        run: |
          # æ¸…ç†æ•´ä¸ªreportsç›®å½•ï¼ŒåŒ…æ‹¬æ—§çš„jmeter-reportç›®å½•
          rm -rf reports
          mkdir -p reports

      - name: Run Selected Testcases
        run: |
          # æ¯æ¬¡æ‰§è¡Œå‰æ¸…ç©º jtl æ–‡ä»¶ï¼Œé¿å…å†å²æ•°æ®å½±å“æŠ¥å‘Š
          > reports/all_cases.jtl

      - name: Run Login Test
        run: |
          ./apache-jmeter-5.6.3/bin/jmeter -n -t testcases/app-bff/tg1_auth_login.jmx -q config/dev.env.properties -l reports/all_cases.jtl

      - name: Check auth_tokens.csv file
        run: |
          echo "Checking if auth_tokens.csv exists..."
          ls -la data/
          if [ -f "data/auth_tokens.csv" ]; then
            echo "auth_tokens.csv exists, content:"
            cat data/auth_tokens.csv
          else
            echo "ERROR: auth_tokens.csv does not exist!"
            echo "Creating empty file for testing..."
            mkdir -p data
            echo "userId,userToken,userAuthorization" > data/auth_tokens.csv
            echo "test,test,test" >> data/auth_tokens.csv
          fi

      - name: Run App Testcases (é»‘åå•æ¨¡å¼)
        run: |
          # é»‘åå•ï¼šè¿™äº›æµ‹è¯•ç”¨ä¾‹å°†è¢«è·³è¿‡
          # æ³¨æ„ï¼štg1_auth_login.jmx å·²ç»åœ¨å‰é¢å•ç‹¬è¿è¡Œè¿‡ï¼Œæ‰€ä»¥åŠ å…¥é»‘åå•é¿å…é‡å¤è¿è¡Œ
          # tg6_forgot_password.jmx ä¼šé€ æˆç³»ç»Ÿç™»å‡ºï¼Œæ”¾åˆ°æœ€åå•ç‹¬è¿è¡Œ
          # tg21_vip_phone.jmx å’Œ tg22_vip_reply.jmxä¼šé€ æˆçº¿ä¸Šä¿¡æ¯æ±¡æŸ“ï¼Œå¯åœ¨æµ‹è¯•ç¯å¢ƒè¿è¡Œã€‚
          blacklist=(
            testcases/app-bff/tg1_auth_login.jmx
            testcases/app-bff/tg6_forgot_password.jmx
            testcases/app-bff/tg21_vip_phone.jmx
            testcases/app-bff/tg22_vip_reply.jmx
          )
          
          echo "Current working directory: $(pwd)"
          echo "Directory contents:"
          ls -la testcases/app-bff/
          echo "Data directory contents:"
          ls -la data/
          echo "CSV file contents before running tests:"
          cat data/auth_tokens.csv
          
          # è·å–æ‰€æœ‰app-bffç›®å½•ä¸‹çš„jmxæ–‡ä»¶
          all_files=($(find testcases/app-bff/ -name "*.jmx" | sort))
          
          echo "Found ${#all_files[@]} test files in app-bff directory"
          
          # è¿è¡Œæ‰€æœ‰éé»‘åå•çš„æµ‹è¯•ç”¨ä¾‹
          for file in "${all_files[@]}"; do
            # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦åœ¨é»‘åå•ä¸­
            skip=false
            for blacklisted in "${blacklist[@]}"; do
              if [[ "$file" == "$blacklisted" ]]; then
                echo "Skipping blacklisted test: $file"
                skip=true
                break
              fi
            done
            
            if [[ "$skip" == false ]]; then
              echo "Running: $file"
              ./apache-jmeter-5.6.3/bin/jmeter -n -t "$file" -q config/dev.env.properties -l reports/all_cases.jtl
            fi
          done

      - name: Run tg6 Forgot Password (æœ€åå•ç‹¬æ‰§è¡Œ)
        run: |
          # tg6_forgot_password.jmx ä¼šé€ æˆç³»ç»Ÿç™»å‡ºï¼Œæ‰€ä»¥æ”¾åˆ°æœ€åå•ç‹¬è¿è¡Œ
          echo "Running tg6_forgot_password.jmx (æœ€åæ‰§è¡Œï¼Œä¼šé€ æˆç³»ç»Ÿç™»å‡º)"
          ./apache-jmeter-5.6.3/bin/jmeter -n -t testcases/app-bff/tg6_forgot_password.jmx -q config/dev.env.properties -l reports/all_cases.jtl

      - name: Generate Unified HTML Report
        run: |
          # ç”Ÿæˆç»Ÿä¸€çš„HTMLæŠ¥å‘Š
          ./apache-jmeter-5.6.3/bin/jmeter -g reports/all_cases.jtl -e -o reports/all_cases_report

      - name: Analyze Test Results
        id: test_results
        run: |
          # åˆ†ææµ‹è¯•ç»“æœï¼Œæå–å¤±è´¥ç”¨ä¾‹ä¿¡æ¯
          echo "=== æµ‹è¯•ç»“æœåˆ†æ ===" > reports/test_summary.txt
          echo "æ€»æµ‹è¯•ç”¨ä¾‹æ•°: $(grep -c '^[0-9]' reports/all_cases.jtl)" >> reports/test_summary.txt
          echo "æˆåŠŸç”¨ä¾‹æ•°: $(grep -c 'true' reports/all_cases.jtl)" >> reports/test_summary.txt
          echo "å¤±è´¥ç”¨ä¾‹æ•°: $(grep -c 'false' reports/all_cases.jtl)" >> reports/test_summary.txt
          echo "" >> reports/test_summary.txt
          
          # ç»Ÿè®¡å¤±è´¥ç”¨ä¾‹æ•°é‡
          failed_count=$(grep -c 'false' reports/all_cases.jtl)
          echo "failed_count=$failed_count" >> $GITHUB_OUTPUT
          
          # æå–å¤±è´¥çš„ç”¨ä¾‹è¯¦æƒ…
          if [ $failed_count -gt 0 ]; then
            echo "=== å¤±è´¥çš„æµ‹è¯•ç”¨ä¾‹ ===" >> reports/test_summary.txt
            # ä½¿ç”¨æ›´ç²¾ç¡®çš„å­—æ®µè§£æï¼ŒJTLæ–‡ä»¶æ ¼å¼ï¼štimestamp,elapsed,label,responseCode,responseMessage,threadName,dataType,success,failureMessage,bytes,sentBytes,grpThreads,allThreads,URL,filename,latencyId,connectTime
            grep 'false' reports/all_cases.jtl | while IFS=',' read -r timestamp elapsed label responseCode responseMessage threadName dataType success failureMessage bytes sentBytes grpThreads allThreads url filename latencyId connectTime; do
              echo "ç”¨ä¾‹: $label" >> reports/test_summary.txt
              echo "å“åº”ç : $responseCode" >> reports/test_summary.txt
              echo "å¤±è´¥åŸå› : $failureMessage" >> reports/test_summary.txt
              echo "" >> reports/test_summary.txt
            done
          else
            echo "æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹éƒ½æ‰§è¡ŒæˆåŠŸï¼" >> reports/test_summary.txt
          fi
          
          # æ˜¾ç¤ºæµ‹è¯•æ‘˜è¦
          cat reports/test_summary.txt
          
          # è®¾ç½®è¾“å‡ºå˜é‡
          echo "summary<<EOF" >> $GITHUB_OUTPUT
          cat reports/test_summary.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Upload reports
        uses: actions/upload-artifact@v4
        with:
          name: jmeter-reports
          path: reports/

      - name: Send success notification
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: ${{ steps.test_results.outputs.failed_count > 0 && 'âŒ JMeter App API æµ‹è¯•å¤±è´¥' || 'âœ… JMeter App API æµ‹è¯•æˆåŠŸ' }} - ${{ github.repository }}
          to: ${{ secrets.NOTIFICATION_EMAIL }}
          from: ${{ secrets.MAIL_USERNAME }}
          body: |
            ${{ steps.test_results.outputs.failed_count > 0 && 'ğŸš¨ JMeter App API æµ‹è¯•æ‰§è¡Œå®Œæˆï¼Œä½†æœ‰å¤±è´¥ç”¨ä¾‹ï¼' || 'ğŸ‰ JMeter App API æµ‹è¯•æ‰§è¡ŒæˆåŠŸï¼' }}
            
            ğŸ“Š æµ‹è¯•è¯¦æƒ…:
            - ä»“åº“: ${{ github.repository }}
            - åˆ†æ”¯: ${{ github.ref_name }}
            - æäº¤: ${{ github.sha }}
            - è§¦å‘è€…: ${{ github.actor }}
            - æ‰§è¡Œæ—¶é—´: ${{ github.event.head_commit.timestamp }}
            
            ğŸ“ˆ æµ‹è¯•ç»“æœæ‘˜è¦:
            ${{ steps.test_results.outputs.summary }}
            
            ğŸ“ è¯¦ç»†æµ‹è¯•æŠ¥å‘Šå·²ç”Ÿæˆï¼Œå¯åœ¨ GitHub Actions ä¸­ä¸‹è½½ã€‚
            
            ğŸ”— æŸ¥çœ‹è¯¦æƒ…: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

      - name: Send failure notification
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "âŒ JMeter App API æµ‹è¯•å¤±è´¥ - ${{ github.repository }}"
          to: ${{ secrets.NOTIFICATION_EMAIL }}
          from: ${{ secrets.MAIL_USERNAME }}
          body: |
            ğŸš¨ JMeter App API æµ‹è¯•æ‰§è¡Œå¤±è´¥ï¼
            
            ğŸ“Š å¤±è´¥è¯¦æƒ…:
            - ä»“åº“: ${{ github.repository }}
            - åˆ†æ”¯: ${{ github.ref_name }}
            - æäº¤: ${{ github.sha }}
            - è§¦å‘è€…: ${{ github.actor }}
            - æ‰§è¡Œæ—¶é—´: ${{ github.event.head_commit.timestamp }}
            
            ğŸ“ˆ æµ‹è¯•ç»“æœæ‘˜è¦:
            ${{ steps.test_results.outputs.summary }}
            
            âš ï¸ è¯·ç«‹å³æ£€æŸ¥æµ‹è¯•å¤±è´¥åŸå› å¹¶ä¿®å¤é—®é¢˜ã€‚
            
            ğŸ”— æŸ¥çœ‹è¯¦æƒ…: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
