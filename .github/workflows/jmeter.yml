name: JMeter CI

on:
  push:
    branches: [ feature/jmeter-login-only ]
  pull_request:
    branches: [ feature/jmeter-login-only ]

jobs:
  jmeter:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install JMeter
        run: |
          wget https://mirrors.tuna.tsinghua.edu.cn/apache/jmeter/binaries/apache-jmeter-5.6.3.tgz
          tar -xzf apache-jmeter-5.6.3.tgz

      - name: Install JMeter Plugins Manager and JSON Path Assertion
        run: |
          wget https://repo1.maven.org/maven2/kg/apc/cmdrunner/2.3/cmdrunner-2.3.jar -O ./apache-jmeter-5.6.3/lib/cmdrunner-2.3.jar
          wget https://jmeter-plugins.org/get/ -O ./apache-jmeter-5.6.3/lib/ext/jmeter-plugins-manager.jar
          java -cp ./apache-jmeter-5.6.3/lib/ext/jmeter-plugins-manager.jar org.jmeterplugins.repository.PluginManagerCMDInstaller
          ./apache-jmeter-5.6.3/bin/PluginsManagerCMD.sh install jpgc-json

      - name: Prepare reports directory
        run: mkdir -p reports

      - name: Run Login Test
        run: |
          ./apache-jmeter-5.6.3/bin/jmeter -n -t testcases/tg1_auth_login.jmx -q config/dev.env.properties -l reports/all_cases.jtl

      - name: Run Selected Testcases
        run: |
          # 每次执行前清空 jtl 文件，避免历史数据影响报告
          > reports/all_cases.jtl
          whitelist=(
            testcases/tg2_registration_register.jmx
            testcases/tg3_auth_logout.jmx
            testcases/tg4_account_activation.jmx
            testcases/tg5_password_reset.jmx
            testcases/tg7_ad_posted_analytics.jmx
            testcases/tg8_post_ad.jmx
            testcases/tg9_delete_ad.jmx
            testcases/tg10_promote_ad_screen.jmx
            testcases/tg11_user_block.jmx
            testcases/tg12_vip_screen.jmx
            testcases/tg13_mygumtree_screen.jmx
            testcases/tg14_favourites.jmx
            testcases/tg15_favourites_screen.jmx
            testcases/tg16_chat_screen.jmx
            testcases/tg17_conversation_screen.jmx
            testcases/tg18_conversation_unread_messages.jmx
            testcases/tg19_conversation.jmx
            testcases/tg20_reviews_conversation.jmx
          )
          for file in "${whitelist[@]}"; do
            ./apache-jmeter-5.6.3/bin/jmeter -n -t "$file" -q config/dev.env.properties -l reports/all_cases.jtl
          done

      - name: Generate Unified HTML Report
        run: |
          ./apache-jmeter-5.6.3/bin/jmeter -g reports/all_cases.jtl -e -o reports/all_cases_report

      - name: Upload reports
        uses: actions/upload-artifact@v4
        with:
          name: jmeter-reports
          path: reports/
